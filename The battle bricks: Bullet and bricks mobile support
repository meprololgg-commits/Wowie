ocal Players = game:GetService("Players")
local CoreGui = game:GetService("CoreGui")

local player = Players.LocalPlayer
local char = player.Character or player.CharacterAdded:Wait()
local hum = char:WaitForChild("Humanoid")

if not player then return end

local screenGui = Instance.new("ScreenGui")
screenGui.Name = "UI"
screenGui.ResetOnSpawn = false
screenGui.Parent = CoreGui

local CurrentTool = nil
local HasCake = false
local CakeActive = false
local Cakecon
local LaughCon

local Button = Instance.new("TextButton")
Button.Name = "Button"
Button.Parent = screenGui
Button.Text = "Ability"
Button.Size = UDim2.new(0.094, 0, 0.147, 0)
Button.Position = UDim2.new(0.877, 0, 0.549, 0)
Button.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
Button.TextColor3 = Color3.fromRGB(255, 255, 255)
Button.TextWrapped = true
Button.Font = Enum.Font.SourceSansBold
Button.TextSize = 24
Button.BorderSizePixel = 0
Button.AutoButtonColor = true
Button.BackgroundTransparency = 0.5

local ConerUi = Instance.new("UICorner")
ConerUi.Parent = Button

local isHolding = false
local TARGETING_RANGE = 250

player.CharacterAdded:Connect(function(newChar)
	char = newChar
	hum = char:WaitForChild("Humanoid")
end)

local function isEnemyTeam(targetPlayer)
	if not player.Team or not targetPlayer.Team then
		return targetPlayer ~= player
	end
	return targetPlayer.Team ~= player.Team
end

local function findClosestEnemy()
	local closestEnemy = nil
	local closestDistance = TARGETING_RANGE
	local closestHRP = nil

	local playerHRP = char:FindFirstChild("HumanoidRootPart")
	if not playerHRP then return nil, nil end

	local playerPos = playerHRP.Position

	local CharactersFolder = workspace:FindFirstChild("Characters")
	if not CharactersFolder then return nil, nil end

	for _, targetChar in CharactersFolder:GetChildren() do
		if targetChar == char then return end

		local targetPlayer = Players:GetPlayerFromCharacter(targetChar)
		if not targetPlayer then return end
		if not isEnemyTeam(targetPlayer) then return end

		local targetHRP = targetChar:FindFirstChild("HumanoidRootPart")
		if not targetHRP then return end

		local targetHumanoid = targetChar:FindFirstChild("Humanoid")
		if not targetHumanoid or targetHumanoid.Health <= 0 then return end

		local targetTool = targetChar:FindFirstChildOfClass("Tool")
		if not targetTool then return end

		local distance = (targetHRP.Position - playerPos).Magnitude
		if distance < closestDistance then
			closestDistance = distance
			closestEnemy = targetPlayer
			closestHRP = targetHRP
		end
	end

	return closestEnemy, closestHRP
end

local function fireAbility()
	if not char then return end

	local tool = char:FindFirstChildOfClass("Tool")
	if not tool then return end

	local RemoteEvent = tool:FindFirstChildOfClass("RemoteEvent")
	if RemoteEvent then
		if tool.Name == "BarbaricTool" then
			RemoteEvent:FireServer("Charge")
		elseif tool.Name == "SpartanTool" then
			RemoteEvent:FireServer("Kick")
		elseif (tool.Name == "StunnerTool" or tool.Name=="PaintballBattlerTool" or tool.Name=="RocketBattlerTool" or tool.Name=="CrocketBattlerTool") then
			local _, targetHRP = findClosestEnemy()
			if targetHRP then
				RemoteEvent:FireServer("Shoot", targetHRP.CFrame)
			else
				print("No enemy in range!")
			end
		elseif tool.Name == "BallerBattlerTool" then
			local _, targetHRP = findClosestEnemy()
			if targetHRP then
				RemoteEvent:FireServer("Shoot", targetHRP.CFrame * CFrame.new(0, 5, 0))
			else
				print("No enemy in range!")
			end
		elseif tool.Name=="GrenadeTool" then
			local _, targetHRP = findClosestEnemy()
			if targetHRP then
				RemoteEvent:FireServer("Throw", targetHRP.CFrame)
			else
				print("No enemy in range!")
			end
		elseif tool.Name == "PukeTool" then
			RemoteEvent:FireServer("Ability")
		elseif tool.Name=="TrowelBattlerTool" or tool.Name=="BuilderBattlerTool" then
			RemoteEvent:FireServer("BuildWall")
		end
		if tool.Name == "CakeTool" and not CakeActive then
			RemoteEvent:FireServer("Ability")
		else
			if tool.Name == "CakeTool" and CakeActive then
				tool:Activate()
				return tool
			end
		end
	else
		if tool.Name == "SpeedsterTool" then
			tool:Activate()
			return tool
		elseif tool.Name == "DarkBattlerTool" then
			tool:Activate()
			return tool
		end
	end
end

Button.InputBegan:Connect(function()
	isHolding = true
	task.spawn(function()
		while isHolding and hum and hum.Health > 0 do
			local tool = fireAbility()
			if tool and CurrentTool ~= tool then
				CurrentTool = tool
			end
			task.wait(0.01)
		end
	end)
end)

Button.InputEnded:Connect(function()
	isHolding = false
	if CurrentTool then
		CurrentTool:Deactivate()
		CurrentTool = nil
	end
end)

local function disclaugh()
	if LaughCon then
		LaughCon:Disconnect()
		LaughCon = nil
	end
end

local function listentocake()
	local tool = char:FindFirstChild("CakeTool")
	if tool then
		local hrp = char:FindFirstChild("HumanoidRootPart")
		if hrp then
			local laughSound = hrp:FindFirstChild("Laugh")
			if laughSound and laughSound:IsA("Sound") then
				disclaugh()
				LaughCon = laughSound.Played:Connect(function()
					CakeActive = true
				end)
			else
				disclaugh()
			end
		end
	end
end

char.ChildAdded:Connect(function(child)
	if child:IsA("Tool") and child.Name == "CakeTool" then
		HasCake = true
		CakeActive = false
		listentocake()
	end
end)

char.ChildRemoved:Connect(function(child)
	if child:IsA("Tool") and child.Name == "CakeTool" then
		HasCake = false
		CakeActive = false
		disclaugh()
	end
end)

player.CharacterAdded:Connect(function(newChar)
	char = newChar
	hum = char:WaitForChild("Humanoid")
	HasCake = false
	CakeActive = false
	disclaugh()
	task.wait(0.1)
	listentocake()
end)

if char:FindFirstChild("CakeTool") then
	HasCake = true
	CakeActive = false
	listentocake()
end

task.spawn(function()
	while true do
		wait(0.08)
		if not char then
			Button.Text = "None"
			continue
		end

		local tool = char:FindFirstChildOfClass("Tool")
		if tool then
			if tool.Name == "BarbaricTool" then
				Button.Text = "Charge"
			elseif tool.Name == "SpartanTool" then
				Button.Text = "Kick"
			elseif (tool.Name == "StunnerTool" or tool.Name=="PaintballBattlerTool" or tool.Name=="RocketBattlerTool" or tool.Name=="BallerBattlerTool" or tool.Name=="CrocketBattlerTool") then
				if tool.Enabled then tool.Enabled = false end
				Button.Text = "Fire"
			elseif tool.Name == "DarkBattlerTool" then
				Button.Text = "SuperPunch"
			elseif tool.Name == "SpeedsterTool" then
				Button.Text = "BONK"
			elseif tool.Name=="TrowelBattlerTool" or tool.Name=="BuilderBattlerTool" then
				Button.Text = "Wall"
			elseif tool.Name=="GrenadeTool" then
				if tool.Enabled then tool.Enabled = false end
				Button.Text = "Throw"
			elseif tool.Name == "CakeTool" then
				if not HasCake then
					HasCake = true
					CakeActive = false
				end
				Button.Text = not CakeActive and "Cake" or "Punch"
			else
				Button.Text = "Ability"
			end
		else
			Button.Text = "None"
		end
	end
end)
