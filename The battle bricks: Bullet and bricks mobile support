local Players = game:GetService("Players")
local CoreGui = game:GetService("CoreGui")
local UserInputService = game:GetService("UserInputService")
local player = Players.LocalPlayer 
local char = player.Character or player.CharacterAdded:Wait()

local screenGui = Instance.new("ScreenGui")
screenGui.Name = "UI"
screenGui.ResetOnSpawn = true
screenGui.Parent = CoreGui

local Button = Instance.new("TextButton")
Button.Name = "Button"
Button.Parent = screenGui
Button.Text = "Ability"
Button.Size = UDim2.new(0.094, 0, 0.147, 0)
Button.Position = UDim2.new(0.877, 0, 0.549, 0) 

local CornerUi = Instance.new("UICorner")
CornerUi.Parent = Button

local isHolding = false
local TARGETING_RANGE = 250


local function findClosestEnemy()
	local closestEnemy = nil
	local closestDistance = TARGETING_RANGE

	for _, targetPlayer in pairs(Players:GetPlayers()) do
		if targetPlayer == player then continue end
		if targetPlayer.Team == player.Team then continue end

		local targetChar = targetPlayer.Character
		if not targetChar then continue end

		local hrp = targetChar:FindFirstChild("HumanoidRootPart")
		local myhrp = char:FindFirstChild("HumanoidRootPart")

		if hrp and myhrp then
			local dist = (hrp.Position - myhrp.Position).Magnitude
			if dist < closestDistance then
				closestDistance = dist
				closestEnemy = targetPlayer
			end
		end
	end

	return closestEnemy
end


local function fireAbility()
	local tool = char:FindFirstChildOfClass("Tool")
	if not tool then return end

	local RemoteEvent = tool:FindFirstChildOfClass("RemoteEvent")
	if not RemoteEvent then return end

	if tool.Name == "BarbaricTool" then
		RemoteEvent:FireServer("Charge")

	elseif tool.Name == "SpartanTool" then
		RemoteEvent:FireServer("Kick")

	elseif tool.Name == "StunnerTool" then
		local enemy = findClosestEnemy()
		if enemy and enemy.Character then
			local hrp = enemy.Character:FindFirstChild("HumanoidRootPart")
			if hrp then
				RemoteEvent:FireServer("Shoot", hrp.Position)
			end
		else
			print("No enemy in range!")
		end
	end
end



Button.MouseButton1Down:Connect(function()
	isHolding = true
	task.spawn(function()
		while isHolding do
			fireAbility()
			task.wait(0.1)
		end
	end)
end)

Button.MouseButton1Up:Connect(function()
	isHolding = false
end)



task.spawn(function()
	while true do
		task.wait(0.08)

		local tool = char:FindFirstChildOfClass("Tool")
		if tool then
			if tool.Name == "BarbaricTool" then
				Button.Text = "Charge"
			elseif tool.Name == "SpartanTool" then
				Button.Text = "Kick"
			elseif tool.Name == "StunnerTool" then
				Button.Text = "Fire"
			else
				Button.Text = "Ability"
			end
		else
			Button.Text = "None"
		end
	end
end)
