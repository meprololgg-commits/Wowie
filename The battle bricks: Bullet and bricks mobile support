local Players = game:GetService("Players")
local CoreGui = game:GetService("CoreGui")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

local player = Players.LocalPlayer
local char = player.Character or player.CharacterAdded:Wait()
local hum = char:WaitForChild("Humanoid")
local camera = workspace.CurrentCamera

local TARGETING_RANGE = 350


local screenGui = Instance.new("ScreenGui")
screenGui.Name = "AbilityUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = CoreGui
local TweenService_upvr= game:GetService("TweenService")
local HumanoidRootPart= char:WaitForChild("HumanoidRootPart")

local Button = Instance.new("TextButton")
Button.Name = "AbilityButton"
Button.Parent = screenGui
Button.Text = "Ability"
Button.Size = UDim2.new(0.094, 0, 0.147, 0)
Button.Position = UDim2.new(0.877, 0, 0.549, 0)
Button.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
Button.TextColor3 = Color3.fromRGB(255, 255, 255)
Button.Font = Enum.Font.SourceSansBold
Button.TextSize = 24
Button.TextWrapped= true
Button.BackgroundTransparency = 0.5
Button.BorderSizePixel = 0
Instance.new("UICorner", Button)


local isHolding = false
local CurrentTool = nil
local HasCake = false
local CakeActive = false
local LaughCon = nil


local function isEnemyTeam(p)
	if not player.Team or not p.Team then return p ~= player end
	return player.Team ~= p.Team
end


local function getBestAimCFrame(targetHRP,tool)
	if not targetHRP then return nil end
	local myHRP = char:FindFirstChild("HumanoidRootPart")
	if not myHRP then return nil end

	local origin = myHRP.Position
	local targetPos = targetHRP.Position

	local velocity = targetHRP.Velocity
	local predicted = targetPos + (velocity * 0.13)


	predicted = predicted + Vector3.new(
		math.random(-12, 12)/100,
		math.random(5, 25)/100,
		math.random(-12, 12)/100
	)

	return CFrame.lookAt(origin, predicted)
end


local function findClosestEnemy()
	local closestHRP = nil
	local closestDist = TARGETING_RANGE
	local myHRP = char:FindFirstChild("HumanoidRootPart")
	if not myHRP then return nil end

	local folder = workspace:FindFirstChild("Characters") or workspace
	for _, targetChar in folder:GetChildren() do
		if targetChar:IsA("Model") and targetChar ~= char then
			local targetPlayer = Players:GetPlayerFromCharacter(targetChar)
			local hrp = targetChar:FindFirstChild("HumanoidRootPart")
			local humanoid = targetChar:FindFirstChild("Humanoid")
			local tool = targetChar:FindFirstChildOfClass("Tool")

			if targetPlayer and hrp and humanoid and humanoid.Health > 0
				and tool and isEnemyTeam(targetPlayer) then
				local dist = (hrp.Position - myHRP.Position).Magnitude
				if dist < closestDist then
					closestDist = dist
					closestHRP = hrp
				end
			end
		end
	end
	return closestHRP
end


local function fireAbility()
	if not char or hum.Health <= 0 then return end
	local tool = char:FindFirstChildOfClass("Tool")
	if not tool then return end

	local remote = tool:FindFirstChildOfClass("RemoteEvent")
	local targetHRP = findClosestEnemy()
	local aimCF = targetHRP and getBestAimCFrame(targetHRP)

	if not remote then
		if tool.Name == "SpeedsterTool" or tool.Name == "DarkBattlerTool" or (tool.Name == "CakeTool" and CakeActive) then
			tool:Activate()
			return tool
		end
		return
	end


	if tool.Name == "BarbaricTool" then
		remote:FireServer("Charge")

	elseif tool.Name == "SpartanTool" then
		remote:FireServer("Kick")

	elseif tool.Name == "PukeTool" then
		remote:FireServer("Ability")

	elseif tool.Name == "TrowelBattlerTool" or tool.Name == "BuilderBattlerTool" then
		remote:FireServer("BuildWall")

	elseif tool.Name == "CakeTool" and not CakeActive then
		remote:FireServer("Ability")

	elseif string.find(tool.Name, "Paintball") or string.find(tool.Name, "Rocket") or string.find(tool.Name, "Stunner") or string.find(tool.Name, "Crocket") or tool.Name=="SlingerBattlerTool"  or tool.Name=="CupcakeLauncher" then
		if aimCF then remote:FireServer("Shoot", aimCF) end
	elseif tool.Name=="SniperTool" then
		if aimCF then
			remote:FireServer("Shoot", aimCF) 
			task.spawn(function()
			TweenService_upvr:Create(HumanoidRootPart, TweenInfo.new(0.15, Enum.EasingStyle.Cubic, Enum.EasingDirection.Out), {
				CFrame = CFrame.lookAt(HumanoidRootPart.Position, Vector3.new(aimCF.Position.X,  aimCF.Position.Y,  aimCF.Position.Z));
				}):Play()
				task.wait(1)
				remote:FireServer("StoppedFiring", aimCF)
			end)
		end
	elseif tool.Name == "BallerBattlerTool" or tool.Name=="SoccerBattlerTool" then
		if aimCF then remote:FireServer("Shoot", aimCF * CFrame.new(0, 5, 0)) end

	elseif tool.Name == "GrenadeTool" or tool.Name=="ArsonTool" then
		if aimCF then remote:FireServer("Throw", tool.Name=="ArsonTool" and aimCF * CFrame.new(0, 5, 0) or aimCF) end
	else
		if aimCF then remote:FireServer("Shoot", aimCF) end
	end
end

Button.InputBegan:Connect(function()
	isHolding = true
	task.spawn(function()
		while isHolding and hum and hum.Health > 0 do
			local tool = fireAbility()
			if tool and CurrentTool ~= tool then
				CurrentTool = tool
			end
			task.wait(0.01)
		end
	end)
end)

Button.InputEnded:Connect(function()
	isHolding = false
	if CurrentTool then
		CurrentTool:Deactivate()
		CurrentTool = nil
	end
end)

local function connectLaughSound()
	task.wait(0.5)
	local hrp = char:FindFirstChild("HumanoidRootPart")
	if not hrp then return end
	local laugh = hrp:FindFirstChild("Laugh")
	if laugh and laugh:IsA("Sound") then
		if LaughCon then LaughCon:Disconnect() end
		LaughCon = laugh.Played:Connect(function()
			CakeActive = true
			task.wait(3)
			CakeActive = false
		end)
	end
end

char.ChildAdded:Connect(function(child)
	if child.Name == "CakeTool" then
		HasCake = true
		CakeActive = false
		connectLaughSound()
	end
end)

char.ChildRemoved:Connect(function(child)
	if child.Name == "CakeTool" then
		HasCake = false
		CakeActive = false
		if LaughCon then LaughCon:Disconnect() end
	end
end)

player.CharacterAdded:Connect(function(newChar)
	char = newChar
	hum = char:WaitForChild("Humanoid")
	HasCake = false
	CakeActive = false
	if LaughCon then LaughCon:Disconnect() end
	task.delay(1, connectLaughSound)
end)


task.spawn(function()
	while task.wait(0.08) do
		local tool = char:FindFirstChildOfClass("Tool")
		if not tool then
			Button.Text = "None"
		else
			if tool.Name == "BarbaricTool" then Button.Text = "Charge"
			elseif tool.Name == "SpartanTool" then Button.Text = "Kick"
			elseif tool.Name == "PukeTool" then Button.Text = "Puke"
			elseif string.find(tool.Name, "Paintball") or string.find(tool.Name, "Rocket") or tool.Name == "StunnerTool" or tool.Name=="SlingerBattlerTool" or tool.Name=="CrocketBattlerTool" or tool.Name=="SniperTool" or tool.Name=="CupcakeLauncher" then Button.Text = "Fire"
			elseif tool.Name == "GrenadeTool" or tool.Name=="ArsonTool" then Button.Text = "Throw"
			elseif tool.Name == "BallerBattlerTool" or tool.Name=="SoccerBattlerTool"  then Button.Text = "Throw"
			elseif tool.Name == "CakeTool" then Button.Text = CakeActive and "Punch" or "Cake"
			elseif tool.Name == "SpeedsterTool" then Button.Text = "BONK"
			elseif tool.Name == "DarkBattlerTool" then Button.Text = "SuperPunch"
			elseif tool.Name == "TrowelBattlerTool" or tool.Name == "BuilderBattlerTool" then Button.Text = "Wall"
			else Button.Text = "Ability"
			end
		end
	end
end)



